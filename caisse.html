<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8">
    <title>Journal de Caisse 2025</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="caisse.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  </head>
  <body>
    <header>
        <h1>üí∞ Journal de Caisse 2025</h1>
        <label>Disponible en caisse :<br><span id="dispo"></span></label>
    </header>
    <main>
      <div class="actions">
        <div class="ajouter">
          <button id="btnAlim" class="green">+ Alimentation</button>
          <button id="btnDep" class="red">+ D√©pense</button>
        </div>
        <div id="stats">
          <button id="btnref" style="display: none;">Tous les mouvements</button>
          <button id="btnMois">Mouvements du mois</button>
          <button id="btnStats">Statistiques</button>
        </div>
      </div>
      <div id="formAlim">
        <div id="topForm">
          <h3>Ajouter une <span id="typeOperation"></span></h3>
          <div id="formbuttons">
            <button id="btnEnregistrerAlim">Enregistrer</button>
            <button id="btnPrint" class="gray">Imprimer</button>
            <button id="btnFermerAlim">Fermer</button>
          </div>
        </div>
        <div id="basForm">
          <div class="labels">
            <label>N¬∞ (auto) :</label>
            <label>Date :</label>
            <label>Libell√© :</label>
            <label>Montant :</label>
            <label>Rubrique :</label>
            <label>Objet :</label>
          </div>
          <div class="inputs">
            <input type="text" id="numop"/>
            <input type="date" id="datop" />
            <input type="text" id="libelop" ></input>
            <input type="number" id="montop" />
            <input type="text" id="rubop" />
            <input type="text" id="objetAlim" />
          </div>
        </div>   
      </div>
      <table>
        <thead>
          <tr>
            <th>N¬∞</th>
            <th>Date</th>
            <th>Libell√©</th>
            <th>D√©bit</th>
            <th>Cr√©dit</th>
            <th>Solde</th>
            <th>Rubrique</th>
            <th>Objet</th>
          </tr>
        </thead>
        <tbody id="table-body"></tbody>
      </table>
    </main>
    <footer>¬© 2025 ‚Äî Journal de Caisse connect√© √† Supabase</footer>
    <script>
    // ‚úÖ Importation correcte (SDK v2)
    const { createClient } = window.supabase;

    // ‚úÖ Configuration du client
    const SUPABASE_URL = "https://ruejiywyrbnlflzyacou.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ1ZWppeXd5cmJubGZsenlhY291Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc2ODI1NDEsImV4cCI6MjA2MzI1ODU0MX0.MaMVpNzCWdiBufFzhd6RL4riLQQejTUG4FWd5cuHUd8";

    // ‚úÖ Cr√©ation du client Supabase
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    // === S√©lecteurs DOM ===
    const formDiv = document.getElementById("formAlim");
    const btnAlim = document.getElementById("btnAlim");
    const btnFermerAlim = document.getElementById("btnFermerAlim");

    // === Affichage / masquage du formulaire ===
    btnAlim.onclick = () => formDiv.style.display = "flex";
    btnFermerAlim.onclick = () => formDiv.style.display = "none";

    // === Chargement initial des donn√©es ===
    async function chargerCaisse() {
        const { data, error } = await supabase
        .from("caisse2025")
        .select("*")
        .order("Date", { ascending: true });

        console.log("üü¢ Donn√©es re√ßues:", data);
        console.log("üî¥ Erreur:", error);

        if (error) {
        alert("‚ùå Impossible de charger les donn√©es : " + error.message);
        return;
        }

        afficherTable(data);
        calculerProchainNo(data);
    }

    // === Affichage du tableau ===
    function afficherTable(donnees) {
    const tbody = document.getElementById("table-body");
    tbody.innerHTML = "";

    let dernierSolde = 0;

    donnees.forEach((ligne) => {
        const tr = document.createElement("tr");

        // On garde le dernier solde connu
        if (ligne.Solde != null) {
        dernierSolde = ligne.Solde;
        }

        tr.innerHTML = `
        <td>${ligne.No || ""}</td>
        <td>${ligne.Date || ""}</td>
        <td>${ligne.Libelles || ""}</td>
        <td style="text-align:right;">
            ${ligne.Debit != null ? ligne.Debit.toLocaleString('fr-TN', { minimumFractionDigits: 3, maximumFractionDigits: 3 }) + " DT" : ""}
        </td>
        <td style="text-align:right;">
            ${ligne.Credit != null ? ligne.Credit.toLocaleString('fr-TN', { minimumFractionDigits: 3, maximumFractionDigits: 3 }) + " DT" : ""}
        </td>
        <td style="text-align:right;font-weight:bold;">
            ${ligne.Solde != null ? ligne.Solde.toLocaleString('fr-TN', { minimumFractionDigits: 3, maximumFractionDigits: 3 }) + " DT" : ""}
        </td>
        <td>${ligne.Rubriques || ""}</td>
        <td>${ligne.Objet || ""}</td>
        `;
        tbody.appendChild(tr);
    });

    // ‚úÖ Mise √† jour du solde disponible
    const dispo = document.getElementById("dispo");
    dispo.textContent = dernierSolde.toLocaleString('fr-TN', { minimumFractionDigits: 3, maximumFractionDigits: 3 }) + " DT";
    activerActionsLigne();
}

// === Variables globales ===
let typeOperation = null;

// === Bouton Alimentation ===
btnAlim.onclick = () => {
typeOperation = "Alimentation";
formDiv.style.display = "flex";
document.getElementById("typeOperation").textContent = "Alimentation";
document.getElementById("btnPrint").style.display = "none";
document.getElementById("numop").value = genererNumero("A");
};

// === Bouton D√©pense ===
const btnDep = document.getElementById("btnDep");
btnDep.onclick = () => {
typeOperation = "D√©pense";
formDiv.style.display = "flex";
document.getElementById("typeOperation").textContent = "D√©pense";
document.getElementById("btnPrint").style.display = "none";
document.getElementById("numop").value = genererNumero("D");
};

// === Fonction pour g√©n√©rer un nouveau num√©ro ===
function genererNumero(prefixe) {
const tbody = document.getElementById("table-body");
const rows = Array.from(tbody.rows);

// On filtre selon le type (A pour alimentation, D pour d√©pense)
const nums = rows
.map(r => r.cells[0]?.textContent)
.filter(n => n && n.startsWith(prefixe === "A" ? "A" : "")) // d√©penses n'ont pas de lettre
.map(n => {
  if (prefixe === "A") return parseInt(n.substring(1)); // enl√®ve le 'A'
  else return parseInt(n); // juste le nombre
})
.filter(n => !isNaN(n));

const max = nums.length > 0 ? Math.max(...nums) : 0;
const suivant = max + 1;

// Si c‚Äôest une d√©pense, on garde toujours deux chiffres
if (prefixe === "A") {
return "A" + suivant;
} else {
return suivant.toString().padStart(2, "0");
}
}
// === Enregistrement d‚Äôune alimentation ou d√©pense ===

document.getElementById("btnEnregistrerAlim").onclick = async () => {
if (!typeOperation) {
alert("‚ö†Ô∏è Choisir le type d‚Äôop√©ration avant d‚Äôenregistrer !");
return;
}

const No = document.getElementById("numop").value.trim();
const DateA = document.getElementById("datop").value;
const Libelles = document.getElementById("libelop").value.trim();
const Montant = Number(parseFloat(document.getElementById("montop").value).toFixed(3));
const Rubriques = document.getElementById("rubop").value.trim() || null;
const Objet = document.getElementById("objetAlim").value.trim() || null;

if (!DateA || !Libelles || !Montant) {
alert("‚ö†Ô∏è Remplir tous les champs obligatoires !");
return;
}

// --- 1Ô∏è‚É£ R√©cup√©rer le dernier solde
let dernierSolde = 0;
const tbody = document.getElementById("table-body");
if (tbody.lastElementChild) {
dernierSolde = parseFloat(
  tbody.lastElementChild.cells[5].textContent.replace(/\s|DT|Dinar/g, "").replace(",", ".")
) || 0;
}

// --- 2Ô∏è‚É£ Logique : Alim = D√©bit / D√©pense = Cr√©dit
let Debit = null, Credit = null, Solde = dernierSolde;
if (typeOperation === "Alimentation") {
Debit = Montant;
Solde += Montant; // la caisse augmente
} else if (typeOperation === "D√©pense") {
Credit = Montant;
Solde -= Montant; // la caisse diminue
}

// --- 3Ô∏è‚É£ Envoi √† Supabase
const { data, error } = await supabase
.from("caisse2025")
.insert([{ No, Date: DateA, Libelles, Debit, Credit, Solde, Rubriques, Objet }])
.select();

if (error) {
alert("‚ùå Erreur : " + error.message);
} else {
alert("‚úÖ " + typeOperation + " enregistr√©e !");
formDiv.style.display = "none";
chargerCaisse();
}
};


// === Activer les actions sur chaque ligne ===

function activerActionsLigne() {
const tbody = document.getElementById("table-body");
const lignes = tbody.querySelectorAll("tr");

lignes.forEach((tr, index) => {
// ‚úÖ Ignorer la premi√®re ligne
if (index === 0) return;

tr.onclick = (e) => {
  e.stopPropagation(); // Emp√™che la propagation du clic vers document

  // Retirer tout ancien menu
  const oldMenu = document.getElementById("ligneActions");
  if (oldMenu) oldMenu.remove();

  // Retirer la s√©lection pr√©c√©dente
  lignes.forEach(l => l.classList.remove("selected"));
  tr.classList.add("selected");

  // Cr√©er le conteneur d‚Äôactions
  const actionRow = document.createElement("tr");
  actionRow.id = "ligneActions";
  const cell = document.createElement("td");
  cell.colSpan = 8;
  cell.style.textAlign = "left";
  cell.style.background = "#f5f5f5";
  cell.style.padding = "8px";

  // Cr√©er les boutons
  const btnModifier = document.createElement("button");
  btnModifier.textContent = "‚úèÔ∏è Modifier";
  btnModifier.className = "action-btn blue";

  const btnImprimer = document.createElement("button");
  btnImprimer.textContent = "üñ®Ô∏è Imprimer";
  btnImprimer.className = "action-btn gray";

  const btnSupprimer = document.createElement("button");
  btnSupprimer.textContent = "üóëÔ∏è Supprimer";
  btnSupprimer.className = "action-btn red";

  const btnAnnuler = document.createElement("button");
  btnAnnuler.textContent = "‚ùå Annuler";
  btnAnnuler.className = "action-btn black";

  // Boutons dans la cellule
  cell.append(btnModifier, btnImprimer);
  if (index === lignes.length - 1) cell.append(btnSupprimer);
  cell.append(btnAnnuler);

  actionRow.appendChild(cell);
  tr.insertAdjacentElement("afterend", actionRow);

// ‚úÖ V√©rifier la position de la ligne pour ne pas cacher le menu sous le footer
  const rect = tr.getBoundingClientRect();
  const footer = document.querySelector("footer");
  const footerRect = footer ? footer.getBoundingClientRect() : null;

  if (footerRect && rect.bottom + 120 > footerRect.top) {
    // S‚Äôil reste peu d‚Äôespace avant le footer ‚Üí ins√©rer avant la ligne
    tr.insertAdjacentElement("beforebegin", actionRow);
  } else {
    // Sinon ‚Üí ins√©rer apr√®s la ligne
    tr.insertAdjacentElement("afterend", actionRow);
  }

  // === Gestion des boutons ===
  btnAnnuler.onclick = (e) => {
    e.stopPropagation();
    actionRow.remove();
    tr.classList.remove("selected");
  };

  btnModifier.onclick = (e) => {
    e.stopPropagation();
    alert(`üìù Modifier la ligne ${tr.cells[0].textContent}`);
  };

  btnImprimer.onclick = (e) => {
    e.stopPropagation();
    alert(`üñ®Ô∏è Impression du mouvement ${tr.cells[0].textContent}`);
  };

  btnSupprimer.onclick = async (e) => {
    e.stopPropagation();
    if (confirm(`‚ö†Ô∏è Supprimer la derni√®re ligne ${tr.cells[0].textContent} ?`)) {
      const { error } = await supabase
        .from("caisse2025")
        .delete()
        .eq("No", tr.cells[0].textContent);

      if (error) {
        alert("‚ùå Erreur : " + error.message);
      } else {
        alert("üóëÔ∏è Ligne supprim√©e !");
        tr.remove();
        actionRow.remove();
        chargerCaisse();
      }
    }
  };
};
});

// ‚úÖ Fermer le menu si on clique ailleurs
document.addEventListener("click", (e) => {
const actionRow = document.getElementById("ligneActions");
if (actionRow && !actionRow.contains(e.target)) {
  actionRow.remove();
  const selected = document.querySelector("tr.selected");
  if (selected) selected.classList.remove("selected");
}
});
}



    // === Filtrer les mouvements du mois courant ===

document.getElementById("btnMois").onclick = () => {
  document.getElementById("btnref").style.display = "inline";
  document.getElementById("btnMois").style.display = "none";

  const tbody = document.getElementById("table-body");
  const rows = Array.from(tbody.rows);

  const now = new Date();
  const mois = now.getMonth() + 1;
  const annee = now.getFullYear();

  rows.forEach(row => {
  const dateCell = row.cells[1].textContent;
  if (!dateCell) {
    row.style.display = "none";
    return;
  }
  const d = new Date(dateCell);
  // cacher les lignes qui ne sont pas du mois courant
  row.style.display = (d.getMonth() + 1 === mois && d.getFullYear() === annee) ? "" : "none";
  });
};

// === R√©initialiser le filtre et tout r√©afficher ===
document.getElementById("btnref").onclick = () => {
  document.getElementById("btnref").style.display = "none";
  document.getElementById("btnMois").style.display = "inline";

  const tbody = document.getElementById("table-body");
  Array.from(tbody.rows).forEach(row => row.style.display = ""); // tout r√©afficher
};



    // === Calcule le prochain num√©ro d‚Äôalimentation (A1, A2, ...) ===
    function calculerProchainNo(data) {
        const alims = data.filter(x => x.No && x.No.startsWith("A"));
        let max = 0;
        alims.forEach(a => {
        const num = parseInt(a.No.substring(1));
        if (num > max) max = num;
        });
        document.getElementById("numop").value = "A" + (max + 1);
    }

    // === Enregistrement d‚Äôune alimentation ===
    document.getElementById("btnEnregistrerAlim").onclick = async () => {
    const No = document.getElementById("numop").value.trim();
    const DateA = document.getElementById("datop").value;
    const Libelles = document.getElementById("libelop").value.trim();
    const Debit = Number(parseFloat(document.getElementById("montop").value).toFixed(3));
    const Rubriques = document.getElementById("rubop").value.trim() || null;
    const Objet = document.getElementById("objetAlim").value.trim() || null;

    if (!DateA || !Libelles || !Debit) {
        alert("‚ö†Ô∏è Remplir tous les champs obligatoires !");
        return;
    }

    // --- 1Ô∏è‚É£ R√©cup√©rer le dernier solde actuel
    let dernierSolde = 0;
    const tbody = document.getElementById("table-body");
    if (tbody.lastElementChild) {
        dernierSolde = parseFloat(
        tbody.lastElementChild.cells[5].textContent.replace(/\s|Dinar/g, "").replace(",", ".")
        );
    }

    // --- 2Ô∏è‚É£ Calculer le nouveau solde apr√®s ce mouvement
    const Solde = dernierSolde + Debit; // alimentation ‚Üí ajout au solde

    // --- 3Ô∏è‚É£ Ins√©rer dans Supabase
    const { data, error } = await supabase
        .from("caisse2025")
        .insert([{ No, Date: DateA, Libelles, Debit, Credit: null, Solde, Rubriques, Objet }])
        .select(); // select() pour r√©cup√©rer la ligne ins√©r√©e

    if (error) {
        console.error("Erreur:", error);
        alert("‚ùå Erreur d'enregistrement : " + error.message);
    } else {
        alert("‚úÖ Alimentation ajout√©e !");

        // --- 4Ô∏è‚É£ Ajouter la nouvelle ligne dans le tableau c√¥t√© client
        afficherTable([...Array.from(tbody.rows).map(r => ({
        No: r.cells[0].textContent,
        Date: r.cells[1].textContent,
        Libelles: r.cells[2].textContent,
        Debit: parseFloat(r.cells[3].textContent.replace(/\s|Dinar/g, "").replace(",", ".")) || null,
        Credit: parseFloat(r.cells[4].textContent.replace(/\s|Dinar/g, "").replace(",", ".")) || null,
        Solde: parseFloat(r.cells[5].textContent.replace(/\s|Dinar/g, "").replace(",", ".")) || null,
        Rubriques: r.cells[6].textContent,
        Objet: r.cells[7].textContent
        })), data[0]]);

        // --- 5Ô∏è‚É£ Mettre √† jour le solde disponible
        const dispo = document.getElementById("dispo");
        dispo.textContent = Solde.toLocaleString('fr-TN', { minimumFractionDigits: 3, maximumFractionDigits: 3 }) + " DT";
        //dispo.style.color = Solde < 0 ? "red" : "green";

        // --- 6Ô∏è‚É£ Fermer le formulaire
        formDiv.style.display = "none";

        // --- 7Ô∏è‚É£ Calculer le prochain num√©ro
        calculerProchainNo([...Array.from(tbody.rows).map(r => ({
        No: r.cells[0].textContent
        })), data[0]]);
    }
    };


    // === Test de connexion rapide ===
    async function testSupabase() {
        const { data, error } = await supabase.from("caisse2025").select("*").limit(1);
        console.log("üß© Test connexion ‚Äî Data:", data);
        console.log("üß© Test connexion ‚Äî Error:", error);
    }

    testSupabase();
    chargerCaisse();
    </script>
  </body>
</html>
