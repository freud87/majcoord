<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <link href="logocnfcpp.png" rel="icon" type="image/x-icon"/>
  <title>MAJ Coordonn√©es</title>
  <link rel="stylesheet" href="index.css">
</head>
<body>
  
    <!-- page de login -->
     <div id="login">
        <div class="cadre">
          <img id="logo" src="logocnfcpp.png" alt="logocnfcpp" width="160">
          <img id="loader" src="load.gif" alt="Chargement..." width="160">
          <img id="fail" src="cinfail.png" alt="CIN introuvable ou erron√© !" width="160">
          <div id="logform">
            <input type="tel" id="cinInput" inputmode="numeric" pattern="[0-9]*" placeholder="Entrer CIN">
            <button onclick="chercherEtudiant()">Chercher</button>
          </div><!-- fin logform -->
          <div id="cinfail">
            <input type="text" id="nomsignal" placeholder="Saisir votre nom">
            <div id="btnfail">
              <button onclick="signaler()">Signaler</button>
              <button id="cinfailcncl">Retour</button>
            </div><!-- fin btnfail -->
          </div><!-- fin cinfail -->
        </div><!-- fin cadre -->
    </div><!-- fin login -->
  <div class="container">
    <div id="infos">
      <h2>Mise √† jour de vos informations</h2>
      <div class="field"><label>Nom :</label><input type="text" id="nom"></div>
      <div class="field"><label>T√©l√©phone 1 :</label><input type="text" id="tel1"></div>
      <div class="field"><label>T√©l√©phone 2 :</label><input type="text" id="tel2"></div>
      <div class="field"><label>Email <span style="color:red">*</span> :</label><input type="email" id="email" required></div>
      <div class="field"><label></label><input type="text" id="modifie" readonly></div>
      <button onclick="soumettre()">Soumettre</button>
    </div>
    <div id="services">
      <h2>R√©cup√©rer vos re√ßus de versement des frais</h2>
      <button id="btnrecu" onclick="getrecu()">Re√ßu d'inscription</button>
    </div>
  </div>
  <div id="notifications"></div>
  <script>
  const apiURL = "https://script.google.com/macros/s/AKfycbx8aH6rH6rBM68_JjSn-YxVjNcPOXHj_VuDg8QiXeskyaNhu91n_YmmIu2asKVc9fCi/exec";
  let currentRow = null;
  let recuURL = null;

  const loader = document.getElementById("loader");
  const logo = document.getElementById("logo");

  // üîπ Fonction d'affichage des notifications
  function showMessage(text, type = "info", duration = 5000) {
  const container = document.getElementById("notifications");
  const msg = document.createElement("div");
  msg.className = `toast ${type}`;
  msg.textContent = text;
  container.appendChild(msg);

  // Disparition apr√®s d√©lai
  setTimeout(() => {
    msg.remove();
  }, duration);
}

  // üîπ Focus au chargement
  window.addEventListener("load", function () {
    const input = document.getElementById("cinInput");
    input.focus();
    setTimeout(() => { input.click(); input.focus(); }, 300);

    toggleFields(true);

    // Retour (CIN fail)
    document.getElementById("cinfailcncl").onclick = () => location.reload();
  });

  // üîπ Activation/D√©sactivation des champs
  function toggleFields(disabled, hasEmail = false) {
    document.getElementById("nom").disabled = disabled;
    document.getElementById("tel1").disabled = disabled;
    document.getElementById("tel2").disabled = disabled;
    document.getElementById("email").disabled = disabled;
    document.getElementById("modifie").disabled = true;

    document.querySelector("button[onclick='soumettre()']").disabled = disabled;
    document.getElementById("btnrecu").disabled = disabled || !hasEmail;
  }

  // üîπ Chercher √©tudiant
  async function chercherEtudiant() {
    const cin = document.getElementById("cinInput").value.trim();
    loader.style.display = "flex";
    logo.style.display = "none";

    if (!cin) {
      loader.style.display = "none";
      logo.style.display = "flex";
      document.getElementById("login").style.display = "flex";
      showMessage("‚ö†Ô∏è Veuillez entrer un CIN !", "error");
      return;
    }

    try {
      const response = await fetch(`${apiURL}?cin=${cin}`);
      const data = await response.json();

      if (Object.keys(data).length === 0) {
        // Pas trouv√©
        document.getElementById("fail").style.display = "flex";
        document.getElementById("logform").style.display = "none";
        document.getElementById("cinfail").style.display = "flex";
        toggleFields(true);
        recuURL = null;
        showMessage("‚ùå CIN introuvable.", "error");
      } else {
        // √âtudiant trouv√©
        document.getElementById("login").style.display = "none";
        currentRow = data.row;

        document.getElementById("nom").value = data.Nom || "";
        document.getElementById("tel1").value = data.Tel1 || "";
        document.getElementById("tel2").value = data.Tel2 || "";
        document.getElementById("email").value = data.Email || "";
        document.getElementById("modifie").value = data.Modifie || "";
        recuURL = data.Recu || null;

        showMessage("‚úÖ CIN trouv√©e.", "success");

        const hasEmail = !!data.Email;
        toggleFields(false, hasEmail);

        document.getElementById("email").addEventListener("input", () => {
          const emailVal = document.getElementById("email").value.trim();
          document.getElementById("btnrecu").disabled = !emailVal;
        });
      }
    } catch (error) {
      console.error(error);
      showMessage("‚ùå Erreur de connexion au serveur.", "error");
      toggleFields(true);
    } finally {
      loader.style.display = "none";
    }
  }

  // üîπ T√©l√©charger re√ßu
  function getrecu() {
    if (!recuURL) {
      showMessage("‚ö†Ô∏è Aucun re√ßu disponible pour ce CIN.", "error");
      return;
    }

    const link = document.createElement("a");
    link.href = recuURL;
    link.target = "_blank";
    link.download = "Recu_Inscription.pdf";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    showMessage("üìÑ Re√ßu t√©l√©charg√©.", "info");
  }

  // üîπ Soumettre mise √† jour
  async function soumettre() {
    if (!currentRow) {
      showMessage("‚ö†Ô∏è Veuillez d'abord saisir votre CIN !", "error");
      return;
    }

    const email = document.getElementById("email").value.trim();
    if (!email) {
      showMessage("‚ö†Ô∏è L'email est obligatoire !", "error");
      return;
    }

    const formData = new URLSearchParams();
    formData.append("row", currentRow);
    formData.append("Nom", document.getElementById("nom").value);
    formData.append("Tel1", document.getElementById("tel1").value);
    formData.append("Tel2", document.getElementById("tel2").value);
    formData.append("Email", email);

    try {
      const response = await fetch(apiURL, { method: "POST", body: formData });
      const result = await response.json();

      if (result.status === "success") {
        document.getElementById("modifie").value = result.modifie || new Date().toLocaleString();
        showMessage("‚úÖ Modification enregistr√©e !", "success");
        setTimeout(() => location.reload(), 2000);
      } else {
        showMessage("‚ùå Erreur lors de la mise √† jour !", "error");
      }
    } catch (error) {
      console.error(error);
      showMessage("‚ùå Erreur de connexion au serveur.", "error");
    }
  }

  // üîπ Signaler erreur
  async function signaler() {
    const nomsignal = document.getElementById("nomsignal").value.trim();
    if (!nomsignal) {
      showMessage("‚ö†Ô∏è Veuillez remplir le champ Nom pour signaler.", "error");
      return;
    }

    const formData = new URLSearchParams();
    formData.append("action", "signalement");
    formData.append("NomSignal", nomsignal);

    try {
      const response = await fetch(apiURL, { method: "POST", body: formData });
      const result = await response.json();

      if (result.status === "success") {
        document.getElementById("nomsignal").value = "";
        showMessage("‚úÖ Signalement enregistr√©, merci !", "success");
      } else {
        showMessage("‚ùå Erreur lors de l'envoi du signalement.", "error");
      }
    } catch (error) {
      console.error(error);
      showMessage("‚ùå Erreur de connexion au serveur.", "error");
    }
  }
</script>

</body>
</html>
