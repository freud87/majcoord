<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <link href="logocnfcpp.png" rel="icon" type="image/x-icon"/>
  <title>MAJ Coordonn√©es</title>
  <link rel="stylesheet" href="index.css">
</head>
<body>
  
  <div class="container">
    <h2>Mise √† jour des coordonn√©es</h2>
    <div id="loader" style="display:none; text-align:center; margin-top:10px;">
      <img src="loader.gif" alt="Chargement..." width="200">
    </div>
    <div class="field row">
      <label id="cinlbl" for="cinInput">CIN :</label>
      <input type="text" id="cinInput">
      <button onclick="chercherEtudiant()">Chercher</button>
    </div>
    <div class="field"><label>Nom :</label><input type="text" id="nom"></div>
    <div class="field"><label>T√©l√©phone 1 :</label><input type="text" id="tel1"></div>
    <div class="field"><label>T√©l√©phone 2 :</label><input type="text" id="tel2"></div>
    <div class="field"><label>Email <span style="color:red">*</span> :</label><input type="email" id="email" required></div>
    <div class="field"><label></label><input type="text" id="modifie" readonly></div>
    <button onclick="soumettre()">Soumettre</button>
    <div id="loader" style="display:none; text-align:center; margin-top:10px;">
      <img src="loader.gif" alt="Chargement..." width="40">
    </div>
    <div id="message" class="message"></div>
  </div>
  <script>
  const apiURL = "https://script.google.com/macros/s/AKfycbx8aH6rH6rBM68_JjSn-YxVjNcPOXHj_VuDg8QiXeskyaNhu91n_YmmIu2asKVc9fCi/exec"; 
  let currentRow = null; 

  // üîπ D√©sactiver tous les champs sauf CIN et Chercher
  window.onload = () => {
    toggleFields(true);
  };

  function toggleFields(disabled) {
    document.getElementById("nom").disabled = disabled;
    document.getElementById("tel1").disabled = disabled;
    document.getElementById("tel2").disabled = disabled;
    document.getElementById("email").disabled = disabled;
    document.getElementById("modifie").disabled = true; // reste toujours readonly
    document.querySelector("button[onclick='soumettre()']").disabled = disabled;
  }

  const loader = document.getElementById("loader");

async function chercherEtudiant() {
  const cin = document.getElementById("cinInput").value.trim();
  const message = document.getElementById("message");

  message.textContent = "";
  loader.style.display = "flex"; // üîπ Affiche le GIF + flou

  if (!cin) {
    loader.style.display = "none"; 
    message.textContent = "‚ö†Ô∏è Veuillez entrer un CIN !";
    message.className = "message error";
    return;
  }

  try {
    const response = await fetch(`${apiURL}?cin=${cin}`);
    const data = await response.json();

    if (Object.keys(data).length === 0) {
      message.textContent = "‚ùå CIN non trouv√©e ou erron√©e!";
      message.className = "message error";
      toggleFields(true);
    } else {
      currentRow = data.row;
      document.getElementById("nom").value = data.Nom || "";
      document.getElementById("tel1").value = data.Tel1 || "";
      document.getElementById("tel2").value = data.Tel2 || "";
      document.getElementById("email").value = data.Email || "";
      document.getElementById("modifie").value = data.Modifie || "";
      message.textContent = "‚úÖ CIN trouv√©e.";
      message.className = "message success";
      toggleFields(false);
    }
  } catch (error) {
    console.error(error);
    message.textContent = "‚ùå Erreur de connexion au serveur.";
    message.className = "message error";
    toggleFields(true);
  } finally {
    loader.style.display = "none"; // üîπ Cache le loader une fois fini
  }
}



  async function soumettre() {
    const message = document.getElementById("message");
    message.textContent = "";

    if (!currentRow) {
      message.textContent = "‚ö†Ô∏è Veuillez d'abord saisir votre CIN !";
      message.className = "message error";
      return;
    }

    const email = document.getElementById("email").value.trim();
    if (!email) {
      message.textContent = "‚ö†Ô∏è L'email est obligatoire !";
      message.className = "message error";
      return;
    }

    const formData = new URLSearchParams();
    formData.append("row", currentRow);
    formData.append("Nom", document.getElementById("nom").value);
    formData.append("Tel1", document.getElementById("tel1").value);
    formData.append("Tel2", document.getElementById("tel2").value);
    formData.append("Email", email);

    try {
      const response = await fetch(apiURL, { method: "POST", body: formData });
      const result = await response.json();

      if (result.status === "success") {
        document.getElementById("modifie").value = result.modifie || new Date().toLocaleString();
        message.textContent = "‚úÖ Modification enregistr√©e !";
        message.className = "message success";
        // üîÑ Recharger la page apr√®s 2 secondes (laisser voir le message avant)
        setTimeout(() => {
          location.reload();
        }, 2000);
      } else {
        message.textContent = "‚ùå Erreur lors de la mise √† jour !";
        message.className = "message error";
      }
    } catch (error) {
      console.error(error);
      message.textContent = "‚ùå Erreur de connexion au serveur.";
      message.className = "message error";
    }
  }
</script>
</body>
</html>
