<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Gestion Étudiants</title>
  <link rel="stylesheet" href="index.css">
</head>
<body>
  <div class="container">
    <h2>Recherche & Modification Étudiant</h2>
    
    
    <div class="field row">
      <label id="cinlbl" for="cinInput">CIN :</label>
      <input type="text" id="cinInput">
      <button onclick="chercherEtudiant()">Chercher</button>
  </div>

    <div class="field"><label>Nom :</label><input type="text" id="nom"></div>
    <div class="field"><label>Téléphone 1 :</label><input type="text" id="tel1"></div>
    <div class="field"><label>Téléphone 2 :</label><input type="text" id="tel2"></div>
    <div class="field"><label>Email <span style="color:red">*</span> :</label><input type="email" id="email" required></div>
    <div class="field"><label></label><input type="text" id="modifie" readonly></div>

    <button onclick="soumettre()">Soumettre</button>

    <div id="message" class="message"></div>
  </div>

  <script>
    const apiURL = "https://script.google.com/macros/s/AKfycbx8aH6rH6rBM68_JjSn-YxVjNcPOXHj_VuDg8QiXeskyaNhu91n_YmmIu2asKVc9fCi/exec"; 
    let currentRow = null; 

    async function chercherEtudiant() {
      const cin = document.getElementById("cinInput").value.trim();
      const message = document.getElementById("message");
      message.textContent = "";

      if (!cin) {
        message.textContent = "⚠️ Veuillez entrer un CIN !";
        message.className = "message error";
        return;
      }

      try {
        const response = await fetch(`${apiURL}?cin=${cin}`);
        const data = await response.json();

        if (Object.keys(data).length === 0) {
          message.textContent = "❌ Aucun étudiant trouvé !";
          message.className = "message error";
        } else {
          currentRow = data.row;
          document.getElementById("nom").value = data.Nom || "";
          document.getElementById("tel1").value = data.Tel1 || "";
          document.getElementById("tel2").value = data.Tel2 || "";
          document.getElementById("email").value = data.Email || "";
          document.getElementById("modifie").value = data.Modifie || "";
          message.textContent = "✅ Étudiant trouvé.";
          message.className = "message success";
        }
      } catch (error) {
        console.error(error);
        message.textContent = "❌ Erreur de connexion au serveur.";
        message.className = "message error";
      }
    }

    async function soumettre() {
      const message = document.getElementById("message");
      message.textContent = "";

      if (!currentRow) {
        message.textContent = "⚠️ Veuillez d'abord rechercher un étudiant !";
        message.className = "message error";
        return;
      }

      const email = document.getElementById("email").value.trim();
      if (!email) {
        message.textContent = "⚠️ L'email est obligatoire !";
        message.className = "message error";
        return;
      }

      const formData = new URLSearchParams();
      formData.append("row", currentRow);
      formData.append("Nom", document.getElementById("nom").value);
      formData.append("Tel1", document.getElementById("tel1").value);
      formData.append("Tel2", document.getElementById("tel2").value);
      formData.append("Email", email);

      try {
        const response = await fetch(apiURL, { method: "POST", body: formData });
        const result = await response.json();

        if (result.status === "success") {
          document.getElementById("modifie").value = result.modifie || new Date().toLocaleString();
          message.textContent = "✅ Modification enregistrée !";
          message.className = "message success";
        } else {
          message.textContent = "❌ Erreur lors de la mise à jour !";
          message.className = "message error";
        }
      } catch (error) {
        console.error(error);
        message.textContent = "❌ Erreur de connexion au serveur.";
        message.className = "message error";
      }
    }
  </script>
</body>
</html>
