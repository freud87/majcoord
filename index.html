<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <link href="logocnfcpp.png" rel="icon" type="image/x-icon"/>
  <title>LTI Pr2</title>
  <link rel="stylesheet" href="index.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
</head>
<body>
  <header>
    <div class="titre">
      <h2>LTI Pr2</h2>
      <h3>Deuxi√®me ann√©e</h3>
    </div>
    <div class="userbox">
      <button class="logoutBtn" id="logoutBtnpc" onclick="location.reload()">D√©connexion</button>
      <button class="logoutBtn" id="logoutBtnmob" onclick="location.reload()"><i class="bi bi-box-arrow-right"></i></button>
    </div>
  </header>
    <!-- page de login -->
     <div id="login">
        <div class="cadre">
          <img id="logo" src="logocnfcpp.png" alt="logocnfcpp">
          <img id="loader" src="load.gif" alt="Chargement...">
          <img id="fail" src="cinfail.png" alt="CIN introuvable ou erron√© !">
          <div id="logform">
            <input type="tel" id="cinInput" inputmode="numeric" pattern="[0-9]*" placeholder="Entrer CIN">
            <button onclick="chercherEtudiant()">Chercher</button>
          </div><!-- fin logform -->
          <div id="cinfail">
            <input type="text" id="nomsignal" placeholder="Saisir votre nom">
            <div id="btnfail">
              <button onclick="signaler()">Signaler</button>
              <button id="cinfailcncl">Retour</button>
            </div><!-- fin btnfail -->
          </div><!-- fin cinfail -->
        </div><!-- fin cadre -->
    </div><!-- fin login -->
  <div class="container">
    <div id="infos">
      <div id="topinfo">
        <h3>Editer vos informations</h3>
        <button onclick="soumettre()">Soumettre</button>
      </div><!-- fin topinfo -->
      <div id="basinfo">
        <div class="labels">
          <label>CIN :</label>
          <label>Nom :</label>
          <label>T√©l√©phone 1<span style="color:red">*</span> :</label>
          <label>T√©l√©phone 2 :</label>
          <label>Email<span style="color:red">*</span> :</label>
          <label>Modifi√© le :</label>
        </div><!-- fin labels -->
        <div class="inputs">
          <input id="infocin" readonly>
          <input type="text" id="nom">
          <input type="text" id="tel1">
          <input type="text" id="tel2">
          <input type="email" id="email" required>
          <label></label><input id="modifie" readonly>
       </div><!-- fin inputs -->
      </div><!-- fin basinfo -->
    </div><!-- fin infos -->
    <div id="services">
      <h3>R√©cup√©rer vos re√ßus de versement des frais</h3>
      <button id="btnrecu" onclick="getrecu()">Re√ßu d'inscription</button>
    </div><!-- fin services -->
  </div><!-- fin container -->
  <div id="notifications"></div>
  <div class="filigrane">LTI Pr2</div>
  <script>
  const apiURL = "https://script.google.com/macros/s/AKfycbx8aH6rH6rBM68_JjSn-YxVjNcPOXHj_VuDg8QiXeskyaNhu91n_YmmIu2asKVc9fCi/exec";
  let currentRow = null;
  let recuURL = null;

  const loader = document.getElementById("loader");
  const logo = document.getElementById("logo");

  // üîπ Fonction d'affichage des notifications
  function showMessage(text, type = "info", duration = 5000) {
  const container = document.getElementById("notifications");
  const msg = document.createElement("div");
  msg.className = `toast ${type}`;
  msg.textContent = text;
  container.appendChild(msg);

  // Disparition apr√®s d√©lai
  setTimeout(() => {
    msg.remove();
  }, duration);
}

  // üîπ Focus au chargement
  window.addEventListener("load", function () {
    const input = document.getElementById("cinInput");
    input.focus();
    setTimeout(() => { input.click(); input.focus(); }, 300);

    toggleFields(true);

    // Retour (CIN fail)
    document.getElementById("cinfailcncl").onclick = () => location.reload();
  });

  // üîπ Activation/D√©sactivation des champs
  function toggleFields(disabled, hasEmail = false) {
    document.getElementById("infocin").disabled = true;
    document.getElementById("nom").disabled = disabled;
    document.getElementById("tel1").disabled = disabled;
    document.getElementById("tel2").disabled = disabled;
    document.getElementById("email").disabled = disabled;
    document.getElementById("modifie").disabled = true;

    document.querySelector("button[onclick='soumettre()']").disabled = disabled;
    document.getElementById("btnrecu").disabled = disabled || !hasEmail;
  }

  // üîπ Chercher √©tudiant
  async function chercherEtudiant() {
    const cin = document.getElementById("cinInput").value.trim();
    loader.style.display = "flex";
    logo.style.display = "none";

    if (!cin) {
      loader.style.display = "none";
      logo.style.display = "flex";
      document.getElementById("login").style.display = "flex";
      showMessage("‚ö†Ô∏è Veuillez entrer le num√©ro de votre CIN !", "error");
      return;
    }

    try {
      const response = await fetch(`${apiURL}?cin=${cin}`);
      const data = await response.json();

      if (Object.keys(data).length === 0) {
        // Pas trouv√©
        document.getElementById("fail").style.display = "flex";
        document.getElementById("logform").style.display = "none";
        document.getElementById("cinfail").style.display = "flex";
        toggleFields(true);
        recuURL = null;
        showMessage("‚ùå Num√©ro de CIN introuvable ou erron√©.", "error");
      } else {
        // √âtudiant trouv√©
        document.getElementById("login").style.display = "none";
        currentRow = data.row;
        
        document.getElementById("infocin").value = cin;
        document.getElementById("nom").value = data.Nom || "";
        document.getElementById("tel1").value = data.Tel1 || "";
        document.getElementById("tel2").value = data.Tel2 || "";
        document.getElementById("email").value = data.Email || "";
        document.getElementById("modifie").value = data.Modifie || "";
        recuURL = data.Recu || null;

        //const nom = document.getElementById("nom").value.trim();
        const nomComplet = document.getElementById("nom").value.trim();
        const mots = nomComplet.split(/\s+/); // d√©coupe par espaces multiples
            let nomAffiche;
            if (mots.length === 1) {
              nomAffiche = mots[0];
            } else if (mots.length === 2) {
              nomAffiche = mots[0];
            } else {
              nomAffiche = mots.slice(0, 2).join(" ");
            }
        showMessage(`üëã Bonjour ${nomAffiche}`, "success");
        //showMessage("‚úÖ CIN trouv√©e.", "success");

        const hasEmail = !!data.Email;
        toggleFields(false, hasEmail);

        document.getElementById("email").addEventListener("input", () => {
          const emailVal = document.getElementById("email").value.trim();
          document.getElementById("btnrecu").disabled = !emailVal;
        });
      }
    } catch (error) {
      console.error(error);
      showMessage("‚ùå Erreur de connexion au serveur.", "error");
      toggleFields(true);
    } finally {
      loader.style.display = "none";
    }
  }

  // üîπ T√©l√©charger re√ßu
  function getrecu() {
    if (!recuURL) {
      showMessage("‚ö†Ô∏è Aucun re√ßu disponible pour vous.", "error");
      return;
    }

    const link = document.createElement("a");
    link.href = recuURL;
    link.target = "_blank";
    link.download = "Recu_Inscription.pdf";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    showMessage("üìÑ Re√ßu t√©l√©charg√©.", "info");
  }

  // üîπ Soumettre mise √† jour
  async function soumettre() {
   /* if (!currentRow) {
      showMessage("‚ö†Ô∏è Veuillez d'abord saisir votre CIN !", "error");
      return;
    }*/

    const email = document.getElementById("email").value.trim();
    if (!email) {
      showMessage("‚ö†Ô∏è L'email est obligatoire !", "error");
      return;
    }

    const formData = new URLSearchParams();
    formData.append("row", currentRow);
    formData.append("Nom", document.getElementById("nom").value);
    formData.append("Tel1", document.getElementById("tel1").value);
    formData.append("Tel2", document.getElementById("tel2").value);
    formData.append("Email", email);

    try {
      const response = await fetch(apiURL, { method: "POST", body: formData });
      const result = await response.json();

      if (result.status === "success") {
        document.getElementById("modifie").value = result.modifie || new Date().toLocaleString();
        showMessage("‚úÖ Modification enregistr√©e !", "success");
        setTimeout(() => window.location.reload(true), 2000);
      } else {
        showMessage("‚ùå Erreur lors de la mise √† jour !", "error");
      }
    } catch (error) {
      console.error(error);
      showMessage("‚ùå Erreur de connexion au serveur.", "error");
    }
  }

  // üîπ Signaler erreur
  async function signaler() {
    const nomsignal = document.getElementById("nomsignal").value.trim();
    if (!nomsignal) {
      showMessage("‚ö†Ô∏è Veuillez saisir votre nom afin de signaler une erreur.", "error");
      return;
    }

    const formData = new URLSearchParams();
    formData.append("action", "signalement");
    formData.append("NomSignal", nomsignal);

    try {
      const response = await fetch(apiURL, { method: "POST", body: formData });
      const result = await response.json();

      if (result.status === "success") {
        document.getElementById("nomsignal").value = "";
        showMessage("‚úÖ Signalement enregistr√©, merci !", "success");
      } else {
        showMessage("‚ùå Erreur lors de l'envoi du signalement.", "error");
      }
    } catch (error) {
      console.error(error);
      showMessage("‚ùå Erreur de connexion au serveur.", "error");
    }
  }
    // üîπ D√©clencher la recherche aussi avec la touche Entr√©e
    document.getElementById("cinInput").addEventListener("keydown", function(e) {
      if (e.key === "Enter") {
        e.preventDefault(); // emp√™che un √©ventuel rechargement
        chercherEtudiant(); // ex√©cute la m√™me fonction que le bouton
      }
    });
</script>
</body>
</html>
