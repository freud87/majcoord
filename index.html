<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <link href="logocnfcpp.png" rel="icon" type="image/x-icon"/>
  <title>MAJ Coordonn√©es</title>
  <link rel="stylesheet" href="index.css">
</head>
<body>
  
  <div class="container">
    <h2>Mise √† jour des coordonn√©es</h2>
    <div id="loader">
      <img src="loader.gif" alt="Chargement..." width="200">
    </div>
    <div id="cinfail">
      <img src="cinfail.png" alt="CIN introuvable ou erron√© !" width="400">
      <div><label>Nom :</label><input type="text" id="nomsignal"></div>
      <button onclick="signaler()">Signaler erreur</button>
      <button id="cinfailcncl">Annuler</button>
    </div>
    <div class="field row">
      <label id="cinlbl" for="cinInput">CIN :</label>
      <input type="text" id="cinInput" inputmode="numeric" pattern="[0-9]*" placeholder="Entrer CIN">
      <button onclick="chercherEtudiant()">Chercher</button>
    </div>
    <div class="field"><label>Nom :</label><input type="text" id="nom"></div>
    <div class="field"><label>T√©l√©phone 1 :</label><input type="text" id="tel1"></div>
    <div class="field"><label>T√©l√©phone 2 :</label><input type="text" id="tel2"></div>
    <div class="field"><label>Email <span style="color:red">*</span> :</label><input type="email" id="email" required></div>
    <div class="field"><label></label><input type="text" id="modifie" readonly></div>
    <button onclick="soumettre()">Soumettre</button>
    <button id="btnrecu" onclick="getrecu()">Re√ßu d'inscription</button>
    <div id="message" class="message"></div>
  </div>
  <script>
    
     window.addEventListener("load", function() {
      const input = document.getElementById("cinInput");

      // Met le focus d√®s le chargement
      input.focus();

      // Petit hack : d√©clencher aussi un "click" pour Android
      setTimeout(() => {
        input.click();
        input.focus();
      }, 300);
    });
    
  const apiURL = "https://script.google.com/macros/s/AKfycbx8aH6rH6rBM68_JjSn-YxVjNcPOXHj_VuDg8QiXeskyaNhu91n_YmmIu2asKVc9fCi/exec"; 
  let currentRow = null; 

  // üîπ D√©sactiver tous les champs sauf CIN et Chercher
  window.onload = () => {
    toggleFields(true);
  // üîπ Met le focus directement sur le champ CIN au chargement
  document.getElementById("cinInput").focus();
 // üîπ Clique sur l'image "cinfail" recharge la page
    document.getElementById("cinfailcncl").onclick = () => {
      location.reload();
    };
  };
  function toggleFields(disabled) {
    document.getElementById("nom").disabled = disabled;
    document.getElementById("tel1").disabled = disabled;
    document.getElementById("tel2").disabled = disabled;
    document.getElementById("email").disabled = disabled;
    document.getElementById("modifie").disabled = true; // reste toujours readonly
    document.querySelector("button[onclick='soumettre()']").disabled = disabled;
    document.querySelector("button[onclick='getrecu()']").disabled = disabled;
  }

  const loader = document.getElementById("loader");

let recuURL = null;

async function chercherEtudiant() {
  const cin = document.getElementById("cinInput").value.trim();
  const message = document.getElementById("message");

  message.textContent = "";
  loader.style.display = "flex";

  if (!cin) {
    loader.style.display = "none"; 
    message.textContent = "‚ö†Ô∏è Veuillez entrer un CIN !";
    message.className = "message error";
    return;
  }

  try {
    const response = await fetch(`${apiURL}?cin=${cin}`);
    const data = await response.json();

    if (Object.keys(data).length === 0) {
      message.textContent = "";
      
      let cinfail = document.getElementById("cinfail");
      cinfail.style.display = "flex";
      cinfail.style.flexDirection = "column";

      toggleFields(true);
      recuURL = null;
    } else {
      currentRow = data.row;
      document.getElementById("nom").value = data.Nom || "";
      document.getElementById("tel1").value = data.Tel1 || "";
      document.getElementById("tel2").value = data.Tel2 || "";
      document.getElementById("email").value = data.Email || "";
      document.getElementById("modifie").value = data.Modifie || "";

      recuURL = data.Recu || null;  // üîπ Stocke l‚ÄôURL du re√ßu

      message.textContent = "‚úÖ CIN trouv√©e.";
      message.className = "message success";
      toggleFields(false);
    }
  } catch (error) {
    console.error(error);
    message.textContent = "‚ùå Erreur de connexion au serveur.";
    message.className = "message error";
    toggleFields(true);
  } finally {
    loader.style.display = "none";
  }
}

    function getrecu() {
  const message = document.getElementById("message");
  message.textContent = "";

  if (!recuURL) {
    message.textContent = "‚ö†Ô∏è Aucun re√ßu disponible pour ce CIN.";
    message.className = "message error";
    return;
  }

  // T√©l√©chargement direct
  const link = document.createElement("a");
  link.href = recuURL;
  link.target = "_blank";  // ouvre dans un nouvel onglet si ce n'est pas un vrai PDF
  link.download = "Recu_Inscription.pdf";
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}




  async function soumettre() {
    const message = document.getElementById("message");
    message.textContent = "";

    if (!currentRow) {
      message.textContent = "‚ö†Ô∏è Veuillez d'abord saisir votre CIN !";
      message.className = "message error";
      return;
    }

    const email = document.getElementById("email").value.trim();
    if (!email) {
      message.textContent = "‚ö†Ô∏è L'email est obligatoire !";
      message.className = "message error";
      return;
    }

    const formData = new URLSearchParams();
    formData.append("row", currentRow);
    formData.append("Nom", document.getElementById("nom").value);
    formData.append("Tel1", document.getElementById("tel1").value);
    formData.append("Tel2", document.getElementById("tel2").value);
    formData.append("Email", email);

    try {
      const response = await fetch(apiURL, { method: "POST", body: formData });
      const result = await response.json();

      if (result.status === "success") {
        document.getElementById("modifie").value = result.modifie || new Date().toLocaleString();
        message.textContent = "‚úÖ Modification enregistr√©e !";
        message.className = "message success";
        // üîÑ Recharger la page apr√®s 2 secondes (laisser voir le message avant)
        setTimeout(() => {
          location.reload();
        }, 2000);
      } else {
        message.textContent = "‚ùå Erreur lors de la mise √† jour !";
        message.className = "message error";
      }
    } catch (error) {
      console.error(error);
      message.textContent = "‚ùå Erreur de connexion au serveur.";
      message.className = "message error";
    }
  }
    async function signaler() {
  const message = document.getElementById("message");
  message.textContent = "";

  const nomsignal = document.getElementById("nomsignal").value.trim();
  if (!nomsignal) {
    message.textContent = "‚ö†Ô∏è Veuillez remplir le champ Nom pour signaler.";
    message.className = "message error";
    return;
  }

  const formData = new URLSearchParams();
  formData.append("action", "signalement");
  formData.append("NomSignal", nomsignal);

  try {
    const response = await fetch(apiURL, { method: "POST", body: formData });
    const result = await response.json();

    if (result.status === "success") {
      message.textContent = "‚úÖ Signalement enregistr√©, merci !";
      message.className = "message success";
      document.getElementById("nomsignal").value = ""; // vide le champ
    } else {
      message.textContent = "‚ùå Erreur lors de l'envoi du signalement.";
      message.className = "message error";
    }
  } catch (error) {
    console.error(error);
    message.textContent = "‚ùå Erreur de connexion au serveur.";
    message.className = "message error";
  }
}

</script>
</body>
</html>
