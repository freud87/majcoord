<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <link href="logocnfcpp.png" rel="icon" type="image/x-icon"/>
  <title>LTI Pr2</title>
  <link rel="stylesheet" href="index.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
</head>
<body>
  <header>
    <div class="titre">
      <h2>LTI Pr2</h2>
      <h3 id="annuniv">Chargement...</h3>
    </div>
    <div class="userbox">
      <button class="logoutBtn" id="logoutBtnpc" onclick="location.reload()">D√©connexion</button>
      <button class="logoutBtn" id="logoutBtnmob" onclick="location.reload()"><i class="bi bi-box-arrow-right"></i></button>
    </div>
  </header>
     <div id="login">
        <div class="cadre">
          <img id="logo" src="logocnfcpp.png" alt="logocnfcpp">
          <img id="loader" src="load.gif" alt="Chargement...">
          <img id="fail" src="cinfail.png" alt="CIN introuvable ou erron√© !">
          <div id="logform">
            <!-- <input type="tel" id="cinInput" inputmode="numeric" pattern="[0-9]*" placeholder="Entrer CIN"> -->
            <input type="tel" id="cinInput" inputmode="tel" placeholder="Entrer CIN">
            <button onclick="chercherEtudiant()">Chercher</button>
          </div><!-- fin logform -->
          <div id="cinfail">
            <input type="text" id="nomsignal" placeholder="Saisir votre nom">
            <div id="btnfail">
              <button id="btnsignal" onclick="signaler()">Signaler</button>
              <button id="cinfailcncl">Retour</button>
            </div><!-- fin btnfail -->
          </div><!-- fin cinfail -->
        </div><!-- fin cadre -->
    </div><!-- fin login -->
  <div class="container">
    <div id="infos">
      <div id="topinfo">
        <h3>Editer vos informations</h3>
        <button id="btnsubmit" onclick="soumettre()">Soumettre</button>
      </div><!-- fin topinfo -->
      <div id="basinfo">
        <div class="labels">
          <label>CIN :</label>
          <label>Nom :</label>
          <label>T√©l√©phone 1<span style="color:red">*</span> :</label>
          <label>T√©l√©phone 2 :</label>
          <label>Email<span style="color:red">*</span> :</label>
          <label>Modifi√© le :</label>
        </div><!-- fin labels -->
        <div class="inputs">
          <input id="infocin" readonly>
          <input type="text" id="nom">
          <input type="text" id="tel1" required>
          <input type="text" id="tel2">
          <input type="email" id="email" required>
          <input id="modifie" readonly>
       </div><!-- fin inputs -->
      </div><!-- fin basinfo -->
    </div><!-- fin infos -->
    <div id="services">
      <div id="recus">
        <h3>R√©cup√©rer vos re√ßus de versement des frais</h3>
        <div id="btnrecus">
          <button id="btnrecu1" onclick="getrecu(1)">Re√ßu 1√®re ann√©e</button>
          <button id="btnrecu2" onclick="getrecu(2)">Re√ßu 2√®me ann√©e</button>
          <button id="btnrecu3" onclick="getrecu(2)">Re√ßu 3√®me ann√©e</button>
        </div><!-- fin btnrecus -->
      </div><!-- fin recus -->
      <div id="autres">
        <h3>Signaler des probl√®mes au niveau de la plateforme</h3>
        <button id="btnm2p" onclick="getm2p()">R√©initialiser mon m2p</button>
      </div><!-- fin autres -->
    </div><!-- fin services -->
  </div><!-- fin container -->
  <div id="notifications"></div>
  <div class="filigrane">LTI Pr2</div>
  <div id="recuPreview" style="display:none; position:fixed; pointer-events:none; z-index:1000; border:2px solid #ccc; border-radius:10px; background:#fff; box-shadow:0 0 15px rgba(0,0,0,0.2);">
    <iframe id="previewFrame" width="400" height="568" style="border:none;"></iframe>
  </div>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    //Ann√©e en cours
    const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSNJhHGgvdyQjfDKHTWpGBWK-jCRNV31zSxJjTYl2tz5WuLp4kUNL8F_Op4KuMXH-0_miPt4Ln9ZlDc/pub?gid=1147238427&single=true&output=csv";

fetch(sheetURL)
  .then(res => res.text())
  .then(csv => {
    const rows = csv.split("\n").map(r => r.split(","));
    const today = new Date();
    let currentAnnee = "Non d√©finie";
    let niveauActuel = null;

    for (let i = 1; i < rows.length; i++) {
      const [niveau, annee, debutStr, finStr] = rows[i].map(v => v.trim());

      const [dDeb, mDeb, yDeb] = debutStr.split("/");
      const [dFin, mFin, yFin] = finStr.split("/");
      const debut = new Date(`${yDeb}-${mDeb}-${dDeb}`);
      const fin = new Date(`${yFin}-${mFin}-${dFin}`);

      if (today >= debut && today <= fin) {
        currentAnnee = annee;
        niveauActuel = niveau;
        break;
      }
    }

    document.getElementById("annuniv").textContent = currentAnnee;

    // üî• Affichage des boutons selon le niveau
    if (niveauActuel >= 1) document.getElementById("btnrecu1").style.display = "inline-block";
    if (niveauActuel >= 2) document.getElementById("btnrecu2").style.display = "inline-block";
    if (niveauActuel >= 3) document.getElementById("btnrecu3").style.display = "inline-block";
  })
  .catch(err => {
    console.error("Erreur import GSheet :", err);
    document.getElementById("annuniv").textContent = "Erreur de chargement";
  });

    //d√©but script
    const apiURL = "https://script.google.com/macros/s/AKfycbx8aH6rH6rBM68_JjSn-YxVjNcPOXHj_VuDg8QiXeskyaNhu91n_YmmIu2asKVc9fCi/exec";
  let currentRow = null;
  //let recuURL = null;
    
    let recu1URL = null;
    let recu2URL = null;

  const loader = document.getElementById("loader");
  const logo = document.getElementById("logo");

  // üîπ Fonction d'affichage des notifications
  function showMessage(text, type = "info", duration = 5000) {
  const container = document.getElementById("notifications");
  const msg = document.createElement("div");
  msg.className = `toast ${type}`;
  //msg.textContent = text;
    msg.innerHTML = text; // ‚úÖ utiliser innerHTML pour afficher les ic√¥nes
  container.appendChild(msg);

  // Disparition apr√®s d√©lai
  setTimeout(() => {
    msg.remove();
  }, duration);
}

  // üîπ Focus au chargement
  window.addEventListener("load", function () {
    const input = document.getElementById("cinInput");
    input.focus();
    setTimeout(() => { input.click(); input.focus(); }, 300);

    // D√©sactiver uniquement les champs qui doivent √™tre en lecture seule
  document.getElementById("infocin").disabled = true;
  document.getElementById("modifie").disabled = true;    
  document.getElementById("btnsubmit").disabled = true;

    // Retour (CIN fail)
    document.getElementById("cinfailcncl").onclick = () => location.reload();
  });

  // üîπ Chercher √©tudiant
  async function chercherEtudiant() {
    const cin = document.getElementById("cinInput").value.trim();
    loader.style.display = "flex";
    logo.style.display = "none";

    if (!cin) {
      loader.style.display = "none";
      logo.style.display = "flex";
      document.getElementById("login").style.display = "flex";
      cinInput.focus();
      showMessage('<i class="bi bi-exclamation-triangle"></i> Veuillez entrer le num√©ro de votre CIN !', "error");
      return;
    }

    try {
      const response = await fetch(`${apiURL}?cin=${cin}`);
      const data = await response.json();

      if (Object.keys(data).length === 0) {
        // Pas trouv√©
        document.getElementById("fail").style.display = "flex";
        document.getElementById("logform").style.display = "none";
        document.getElementById("cinfail").style.display = "flex";
        document.getElementById("btnsubmit").disabled = true; // Garder d√©sactiv√©
        //recuURL = null;
        recu1URL = null;
        recu2URL = null;
        nomsignal.focus();
        showMessage('<i class="bi bi-x-square"></i> Num√©ro de CIN introuvable ou erron√©.', "error");
      } else {
        // √âtudiant trouv√©        
        document.getElementById("login").style.display = "none";
        currentRow = data.row;
        
        document.getElementById("infocin").value = cin;
        document.getElementById("nom").value = data.Nom || "";
        document.getElementById("tel1").value = data.Tel1 || "";
        document.getElementById("tel2").value = data.Tel2 || "";
        document.getElementById("email").value = data.Email || "";

// üîπ Formater la date si elle existe
if (data.Modifie) {
  const d = new Date(data.Modifie);
  const formatted = d.toLocaleString("fr-FR", {
    day: "2-digit",
    month: "2-digit",
    year: "numeric",
    hour: "2-digit",
    minute: "2-digit",
    hour12: false
  });
  document.getElementById("modifie").value = formatted;
} else {
  document.getElementById("modifie").value = "";
}

        recu1URL = data.Recu1 || null;
        recu2URL = data.Recu2 || null;

        document.getElementById("btnrecu1").disabled = !recu1URL;
        document.getElementById("btnrecu2").disabled = !recu2URL;

        // D√©sactiver le bouton initialement
      document.getElementById("btnsubmit").disabled = true;

      // üî• POSER LE SURVEILLANT DE MODIFICATION
      surveillerModifications();

        //const nom = document.getElementById("nom").value.trim();
        const nomComplet = document.getElementById("nom").value.trim();
        const mots = nomComplet.split(/\s+/); // d√©coupe par espaces multiples
            let nomAffiche;
            if (mots.length === 1) {
              nomAffiche = mots[0];
            } else if (mots.length === 2) {
              nomAffiche = mots[0];
            } else {
              nomAffiche = mots.slice(0, 2).join(" ");
            }
        showMessage(`<i class="bi bi-emoji-smile"></i> Bonjour ${nomAffiche}`, "success");
   

        const hasEmail = !!data.Email;
        //toggleFields(false, hasEmail);

       /* document.getElementById("email").addEventListener("input", () => {
          const emailVal = document.getElementById("email").value.trim();
          document.getElementById("btnrecu").disabled = !emailVal;
        });*/
        // üîÑ ‚è≥ Compte √† rebours 3 minutes avant rechargement
        let remaining = 180;
        const timer = setInterval(() => {
          remaining--;
          if (remaining === 10) showMessage('<i class="bi bi-hourglass-split"></i> Vous serez d√©connect√©(e) dans 10 secondes.', "info");
          if (remaining <= 0) {
            clearInterval(timer);
            window.location.reload(true);
          }
        }, 1000);
      }
      
    } catch (error) {
      console.error(error);
      showMessage('<i class="bi bi-database-fill-x"></i> Erreur de connexion au serveur.', "error");
      //toggleFields(true);
    } finally {
      loader.style.display = "none";
    }
  }
  // üîπ SURVEILLANT DE MODIFICATION
function surveillerModifications() {
  const champsASurveiller = ['nom', 'tel1', 'tel2', 'email'];
  const btnsubmit = document.getElementById("btnsubmit");
  
  champsASurveiller.forEach(champId => {
    const champ = document.getElementById(champId);
    
    // Sauvegarder la valeur initiale
    champ.dataset.valeurInitiale = champ.value;
    
    // √âcouter les modifications
    champ.addEventListener('input', function() {
      // V√©rifier si la valeur actuelle est diff√©rente de la valeur initiale
      const aChange = champsASurveiller.some(id => {
        const element = document.getElementById(id);
        return element.value !== element.dataset.valeurInitiale;
      });
      
      // Activer le bouton seulement si il y a des modifications
      btnsubmit.disabled = !aChange;
    });
  });
}
  // üîπ T√©l√©charger re√ßu 1√®re ou 2√®me ann√©e
function getrecu(annee) {
    // On r√©cup√®re l'ID au lieu de l'URL
  const recuID = (annee === 1) ? recu1URL : recu2URL;
  let suffixe = (annee == 1) ? "√®re" : "√®me";

  if (!recuID) {
    showMessage(`<i class="bi bi-file-earmark-x"></i> Aucun re√ßu disponible pour la ${annee}${suffixe} ann√©e.`, "error");
    return;
  }

  // Construit dynamiquement l‚ÄôURL de t√©l√©chargement
  const recuURL = `https://drive.google.com/uc?export=download&id=${recuID}`;

  // Cr√©e un lien de t√©l√©chargement invisible
  const link = document.createElement("a");
  link.href = recuURL;
  link.target = "_blank";
  link.download = `Recu_${annee}e_annee.pdf`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);

  showMessage(`<i class="bi bi-file-earmark-check"></i> Re√ßu ${annee}${suffixe} ann√©e t√©l√©charg√©.`, "info");
}


  // üîπ Soumettre mise √† jour
  async function soumettre() {
  const tel1 = document.getElementById("tel1").value.trim();
  const email = document.getElementById("email").value.trim();

  if (!tel1) {
    showMessage('<i class="bi bi-telephone"></i> Le num√©ro de t√©l√©phone est obligatoire !', "error");
    return;
  }

  if (!email) {
    showMessage('<i class="bi bi-envelope-at"></i> L‚Äôemail est obligatoire !', "error");
    return;
  }

  const formData = new URLSearchParams();
  formData.append("row", currentRow);
  formData.append("Nom", document.getElementById("nom").value);
  formData.append("Tel1", tel1);
  formData.append("Tel2", document.getElementById("tel2").value);
  formData.append("Email", email);

  try {
    const response = await fetch(apiURL, { method: "POST", body: formData });
    const result = await response.json();

    if (result.status === "success") {
      document.getElementById("modifie").value = result.modifie || new Date().toLocaleString();
      
      // üî• METTRE √Ä JOUR LES VALEURS INITIALES APR√àS SOUMISSION
      mettreAJourValeursInitiales();
      
      // D√©sactiver le bouton apr√®s soumission r√©ussie
      document.getElementById("btnsubmit").disabled = true;
      
      showMessage('<i class="bi bi-floppy"></i> Modification enregistr√©e !', "success");
    } else {
      showMessage('<i class="bi bi-database-fill-x"></i> Erreur lors de la mise √† jour !', "error");
    }
  } catch (error) {
    console.error(error);
    showMessage('<i class="bi bi-database-exclamation"></i> Erreur de connexion au serveur.', "error");
  }
}
// üîπ METTRE √Ä JOUR LES VALEURS INITIALES
function mettreAJourValeursInitiales() {
  const champsASurveiller = ['nom', 'tel1', 'tel2', 'email'];
  champsASurveiller.forEach(champId => {
    const champ = document.getElementById(champId);
    champ.dataset.valeurInitiale = champ.value;
  });
}
  // üîπ Signaler erreur
  async function signaler() {
    const nomsignal = document.getElementById("nomsignal").value.trim();
    if (!nomsignal) {
      //nomsignal.focus();
      showMessage('<i class="bi bi-exclamation-triangle"></i> Veuillez saisir votre nom afin de signaler une erreur.', "error");
      return;
    }

    const formData = new URLSearchParams();
    formData.append("action", "signalement");
    formData.append("NomSignal", nomsignal);

    try {
      const response = await fetch(apiURL, { method: "POST", body: formData });
      const result = await response.json();

      if (result.status === "success") {
        document.getElementById("nomsignal").value = "";
        showMessage('<i class="bi bi-send-check"></i> Signalement envoy√©, merci !', "success");
      } else {
        showMessage('<i class="bi bi-send-x"></i> Erreur lors de l\'envoi du signalement.', "error");
      }
    } catch (error) {
      console.error(error);
      showMessage('<i class="bi bi-database-exclamation"></i> Erreur de connexion au serveur.', "error");
    }
  }
    // üîπ D√©clencher la recherche aussi avec la touche Entr√©e
    document.getElementById("cinInput").addEventListener("keydown", function(e) {
      if (e.key === "Enter") {
        e.preventDefault(); // emp√™che un √©ventuel rechargement
        chercherEtudiant(); // ex√©cute la m√™me fonction que le bouton
      }
    });
    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // üîπ Pr√©visualisation dynamique du re√ßu
const previewBox = document.getElementById("recuPreview");
const previewFrame = document.getElementById("previewFrame");

// D√©placement du cadre avec la souris
document.addEventListener("mousemove", (e) => {
  if (previewBox.style.display === "block") {
    const offsetX = 15; // petit √©cart du curseur
    const offsetY = 15;

    // On r√©cup√®re les dimensions du cadre
    const previewWidth = previewBox.offsetWidth;
    const previewHeight = previewBox.offsetHeight;

    // Si le bouton est √† droite, on place le cadre √† gauche de la souris
    let left = e.clientX - previewWidth - offsetX;
    let top = e.clientY - offsetY;

    // Emp√™cher que la fen√™tre sorte de l‚Äô√©cran
    if (left < 0) left = 10;
    if (top + previewHeight > window.innerHeight)
      top = window.innerHeight - previewHeight - 10;

    previewBox.style.left = `${left}px`;
    previewBox.style.top = `${top}px`;
  }
});

// Fonction d'affichage du re√ßu
function showRecuPreview(annee) {
  const recuID = (annee === 1) ? recu1URL : recu2URL;
  if (!recuID) return;
  
  const recuURL = `https://drive.google.com/file/d/${recuID}/preview`;
  previewFrame.src = recuURL;
  previewBox.style.display = "block";
}

// Fonction pour cacher le re√ßu
function hideRecuPreview() {
  previewBox.style.display = "none";
  previewFrame.src = "";
}

// Attache les √©v√©nements aux boutons
document.getElementById("btnrecu1").addEventListener("mouseenter", () => showRecuPreview(1));
document.getElementById("btnrecu2").addEventListener("mouseenter", () => showRecuPreview(2));
document.getElementById("btnrecu3").addEventListener("mouseenter", () => showRecuPreview(3));

document.getElementById("btnrecu1").addEventListener("mouseleave", hideRecuPreview);
document.getElementById("btnrecu2").addEventListener("mouseleave", hideRecuPreview);
document.getElementById("btnrecu3").addEventListener("mouseleave", hideRecuPreview);

</script>
</body>
</html>
